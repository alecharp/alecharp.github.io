<html>
<head>
  <meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>alecharp&#39;s blog: Quand les tests te sauvent les fesses</title>

  <link href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:200,600" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" media="screen" href="/css/index.css" />
  <link rel="stylesheet" media="screen" href="/css/syntax.css" />
  <link rel="stylesheet" media="screen" href="/css/font-awesome.min.css" />
</head>

<body>

<navbar>
  <div><a href="/" title="alecharp&#39;s blog">alecharp&#39;s blog</a></div>
  <nav>
    <ul>
      <li>
        <a href="//twitter.com/alecharp" title="alecharp's Twitter"><i class="fa fa-twitter"></i></a>
      </li>
      <li>
        <a href="//github.com/alecharp" title="alecharp's Github"><i class="fa fa-github"></i></a>
      </li>
      <li>
        <a href="/index.xml" title="alecharp&#39;s blog's RSS"><i class="fa fa-rss"></i></a>
      </li>
      <li>
        <a href="//speakerdeck.com/alecharp" title="alecharp's SpeakerDeck"><i class="fa fa-slideshare"></i></a>
      </li>
    </ul>
  </nav>
</navbar>


<main>
  

<article>
  <header>
    <h1>Quand les tests te sauvent les fesses</h1>
    <time pubdate="2014-06-09">
      <i class="fa fa-calendar"></i> 2014-06-09
    </time>
  </header>
  <section>
    

<p>Depuis quelques temps, je me force à faire toute une panoplie de tests pour tous les développements que je fais. Qu&rsquo;ils soient unitaires ou d&rsquo;intégrations.</p>

<p>C&rsquo;est une bonne pratique que je recommande depuis quelques temps déjà, il était donc grand temps que je le fasse&hellip;</p>

<blockquote>
<p>Faites ce que je dis, pas ce que je fais.</p>
</blockquote>

<h2 id="contexte">Contexte</h2>

<p>Depuis quelques semaines, quand j&rsquo;ai du temps, je me consacre au développement encore secret mais bientôt relâché dans la nature de l&rsquo;open-source.</p>

<p>Pour ce projet, j&rsquo;utilise XStream pour écrire une liste de serveurs dans un fichier sous la forme :</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="lnt">1</span><span class="lnt">2</span><span class="lnt">3</span><span class="lnt">4</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;servers&gt;</span>
  <span class="nt">&lt;server</span> <span class="na">name=</span><span class="s">&#34;toto&#34;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/server&gt;</span>
<span class="nt">&lt;/servers&gt;</span></code></pre></td></tr></table>
</div>
</div>

<p>Pourquoi ce format : simple à comprendre et donc à éditer à la main.</p>

<h2 id="réalisation">Réalisation</h2>

<p>Rien de bien compliqué, on regarde les 2-3 libs connues sur la manipulation de XML dans le monde Java, on fait son choix, on lit la documentation et hop, on code.</p>

<h3 id="première-étape-java-xml">Première étape: Java &ndash;› XML</h3>

<p>On crée une instance de XStream, on lui dit que les classes <code>Server.java</code> seront en fait appelées <code>server</code> dans l&rsquo;xml. La liste, elle, sera appelée <code>servers</code>.</p>

<p>On veut que le nom du serveur soit un attribut du tag, soit on fait compliqué avec une implémentation de <code>Converter</code> soit on fait <code>xStream.useAttributeFor(Server.class, &quot;name&quot;);</code>. Donc on fait le premier car un <code>Converter</code> c&rsquo;est cool.</p>

<p>La transformation se fera alors avec un <code>xStream.toXml()</code></p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerListToXML</span> <span class="o">{</span>
    <span class="nd">@Import</span> <span class="kd">private</span> <span class="n">ServerService</span> <span class="n">serverService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">XStream</span> <span class="n">xStream</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">ServerListToXML</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">registerConverter</span><span class="o">(</span><span class="k">new</span> <span class="n">ServerConverter</span><span class="o">());</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">alias</span><span class="o">(</span><span class="s">&#34;server&#34;</span><span class="o">,</span> <span class="n">Server</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">alias</span><span class="o">(</span><span class="s">&#34;servers&#34;</span><span class="o">,</span> <span class="n">List</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">save</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span> <span class="n">serverListing</span> <span class="o">=</span> <span class="n">serverService</span><span class="o">.</span><span class="na">getAll</span><span class="o">();</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">toXML</span><span class="o">(</span><span class="n">serverListing</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>

<p>Évidemment, on fait nos tests unitaires. Ça passe dans le vert, on <code>git add</code> / <code>git commit</code>.</p>

<h3 id="deuxième-étape-xml-java">Deuxième étape: XML &ndash;› Java</h3>

<p>Basiquement, le chemin aller a fonctionné, donc on fait <code>xStream.fromXml()</code> et tout se passe bien. Devrait en fait&hellip;</p>

<p>Oui car en fait, l&rsquo;alias sur la classe <code>List</code>, c&rsquo;est pas une super idée. Il vaut mieux utiliser <code>addImplicitCollection()</code>. Mais pour ça, il faut une classe concrète. Je décide donc de créer une classe pour contenir mes serveurs.</p>

<p>Je rajoute donc dans mon constructeur :</p>

<p><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span><span class="lnt">15</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="o">...</span>
    <span class="kd">public</span> <span class="nf">ServerListToXML</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">xStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XStream</span><span class="o">();</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">registerConverter</span><span class="o">(</span><span class="k">new</span> <span class="n">ServerConverter</span><span class="o">());</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">alias</span><span class="o">(</span><span class="s">&#34;server&#34;</span><span class="o">,</span> <span class="n">Server</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">xStream</span><span class="o">.</span><span class="na">alias</span><span class="o">(</span><span class="s">&#34;servers&#34;</span><span class="o">,</span> <span class="n">ServerListing</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">xStream</span><span class="o">.</span><span class="na">addImplicitCollection</span><span class="o">(</span><span class="n">ServerListing</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;list&#34;</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="o">...</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">input</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ServerListing</span> <span class="n">listing</span> <span class="o">=</span> <span class="o">(</span><span class="n">ServerListing</span><span class="o">)</span> <span class="n">xStream</span><span class="o">.</span><span class="na">fromXML</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
        <span class="n">listing</span><span class="o">.</span><span class="na">getList</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="nl">serverService:</span><span class="o">:</span><span class="n">addServer</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div></p>

<p>Du coup, là, tout fonctionne parfaitement. Théoriquement. Donc on met en place des tests unitaires. Ça fonctionne, pour 1 serveur. Mais pas pour 2.</p>

<p>Donc on passse en Debug, on se prend la tête. Et puis, on se dit : &ldquo;Qu&rsquo;est-ce que j&rsquo;ai codé qui pourrait faire que cela ne fonctionne pas ?&rdquo;. On retourne la question dans tous les sens puisque le code écrit ne casse pas le fonctionnement de la sauvegarde (test à l&rsquo;appui) et là on se souvient que dans notre <code>ServerConverter</code> il y a aussi une méthode <code>unmarshal</code>. On revient dessus pour finalement voir un <code>moveUp()</code> en trop après le <code>while(reader.hasMoreChildren()) {..}</code>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Faire des tests m&rsquo;a montré que ce que j&rsquo;ai écrit fonctionne, que je peux ajouter de nouvelles fonctionnalités sans avoir peur et surtout que je peux faire du refactoring dessus.</p>

  </section>
</article>


</main>

  <footer>
    &copy; Adrien Lecharpentier 2012 - 2017
  </footer>

</body>
</html>

