<html>
<head>
  <meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>alecharp.fr: Never ever use finalize in Java</title>

  <link href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:200,600" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" media="screen" href="/css/index.css" />
  <link rel="stylesheet" media="screen" href="/css/syntax.css" />
  <link rel="stylesheet" media="screen" href="/css/font-awesome.min.css" />
</head>

<body>
  <div id="container">

<navbar>
  <div class="spacer"></div>
  <div><a href="/" title="alecharp.fr">alecharp.fr</a></div>
  <nav>
    <ul>
      <li>
        <a href="//twitter.com/alecharp" title="alecharp's Twitter"><i class="fa fa-twitter"></i></a>
      </li>
      <li>
        <a href="//github.com/alecharp" title="alecharp's Github"><i class="fa fa-github"></i></a>
      </li>
      <li>
        <a href="/index.xml" title="alecharp.fr's RSS"><i class="fa fa-rss"></i></a>
      </li>
      <li>
        <a href="//speakerdeck.com/alecharp" title="alecharp's SpeakerDeck"><i class="fa fa-slideshare"></i></a>
      </li>
    </ul>
  </nav>
</navbar>


<main>
  

<article>
  <header>
    <h1>Never ever use finalize in Java</h1>
    <time pubdate="2013-05-30">
      <i class="fa fa-calendar"></i> 2013-05-30
    </time>
  </header>
  <section>
    

<p>À moins de s&rsquo;avoir parfaitement ce que vous faite et comment ce que vous faites sera utilisé dans le futur&hellip;</p>

<p>Parce que lorsque l&rsquo;on fait du support, en général on ne touche pas trop à du code bien fait / écrit ni fonctionnel (un produit qui fonctionne n&rsquo;a pas besoin de support), je vois par moment des choses qui peuvent piquer les yeux.</p>

<p>Dernier en date : utilisation de la méthode <code>finalize</code> de Java.</p>

<h2 id="rappel">Rappel</h2>

<p>En C++, il y a les destructeurs, donc on pourrait penser que c&rsquo;est la même chose : pas du tout ! Le destructeur en C++ est responsable de la désallocation de la mémoire utilisée par l&rsquo;objet.</p>

<p>La méthode <code>finalize</code> est appelée lorsque le GC passe sur l&rsquo;instance d&rsquo;une classe. On peut alors souhaiter effectuer certaines actions à ce moment là mais il faut faire très attention car une simple raison : on ne sait pas quand le GC passe !</p>

<h2 id="mise-en-situation-de-ce-qu-il-ne-faut-pas-faire">Mise en situation de ce qu&rsquo;il ne faut pas faire</h2>

<h3 id="code">Code</h3>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">A</span> <span class="p">{</span>
	<span class="kd">private</span> <span class="nf">B</span> <span class="n">b</span><span class="p">;</span>
		
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">finalize</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">b</span><span class="p">.</span><span class="na">setC</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">B</span> <span class="p">{</span>
	<span class="kd">private</span> <span class="nf">C</span> <span class="n">c</span><span class="p">;</span>
	
	<span class="kd">public</span> <span class="nf">void</span> <span class="n">setC</span><span class="p">(</span><span class="n">C</span> <span class="nf">c</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="na">c</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span> <span class="p">}</span>
	
	<span class="kd">public</span> <span class="nf">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&#34;B: &#34;</span> <span class="o">+</span> <span class="n">c</span><span class="p">.</span><span class="na">toString</span><span class="p">();</span> <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="nf">class</span> <span class="n">C</span> <span class="p">{</span>
	<span class="kd">public</span> <span class="nf">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&#34;C&#34;</span> <span class="p">}</span>
<span class="p">}</span></code></pre></td></tr></table>
</div>
</div>

<h3 id="exécution">Exécution</h3>

<p>Si votre classe B est un singleton géré par un système tiers, alors on pourrait avoir 10000 instances de A avec la même instance de B. Si, par manque de ressources ou parce que le GC veut faire un peu de ménage, le GC supprime au moins une instance de A, alors</p>

<blockquote>
<p>&ldquo;You gonna have a bad time&rdquo;</p>
</blockquote>

<h3 id="explication">Explication</h3>

<p>Lors du passage du GC, les méthodes <code>finalize</code> sont appelées, sur le principe que toute classe est une fille de la classe <code>Object</code> qui définit cette méthode. Donc si une instance de A est déchargée, elle va mettre à <code>null</code> la référence à une instance de C dans l&rsquo;instance de B.</p>

<blockquote>
<p>NPE guaranteed</p>
</blockquote>

<p>En effet, l&rsquo;instance de la classe B est toujours utilisé par d&rsquo;autres instance de la classe A.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Il y a quelques années, un enseignant nous avait dit :</p>

<blockquote>
<p>&ldquo;Le premier que je vois redéfinir <code>finalize</code> sans une excellente raison passera un sale quart d&rsquo;heure&rdquo;, <strong>Rémi FORAX</strong>.</p>
</blockquote>

<p>Depuis j&rsquo;applique ce précepte : &ldquo;Je ne sais pas suffisamment comment ça sera utilisé pour être capable de faire une redéfinition parfaite&rdquo;, donc je ne redéfinis <strong>jamais</strong> la méthode <code>finalize</code>.</p>

  </section>
</article>


</main>

  <footer>
    &copy; 2012 - 2019
  </footer>

  </div>
</body>
</html>

