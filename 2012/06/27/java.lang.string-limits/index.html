<html>
<head>
  <meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>alecharp&#39;s blog: java.lang.String limits</title>

  <link href="https://fonts.googleapis.com/css?family=Fira+Sans+Extra+Condensed:200,600" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" media="screen" href="/css/index.css" />
  <link rel="stylesheet" media="screen" href="/css/syntax.css" />
  <link rel="stylesheet" media="screen" href="/css/font-awesome.min.css" />
</head>

<body>

<navbar>
  <div><a href="/" title="alecharp&#39;s blog">alecharp&#39;s blog</a></div>
  <nav>
    <ul>
      <li>
        <a href="//twitter.com/alecharp" title="alecharp's Twitter"><i class="fa fa-twitter"></i></a>
      </li>
      <li>
        <a href="//github.com/alecharp" title="alecharp's Github"><i class="fa fa-github"></i></a>
      </li>
      <li>
        <a href="/index.xml" title="alecharp&#39;s blog's RSS"><i class="fa fa-rss"></i></a>
      </li>
      <li>
        <a href="//speakerdeck.com/alecharp" title="alecharp's SpeakerDeck"><i class="fa fa-slideshare"></i></a>
      </li>
    </ul>
  </nav>
</navbar>


<main>
  

<article>
  <header>
    <h1>java.lang.String limits</h1>
    <time pubdate="2012-06-27">
      <i class="fa fa-calendar"></i> 2012-06-27
    </time>
  </header>
  <section>
    

<p>Facepalm with String limits
S&rsquo;il y a bien une chose que l&rsquo;on peut très vite oublier avec Java,
c&rsquo;est la gestion de la mémoire. Et quand on fait des traitements lourds
et longs, ça nous revient très rapidement en plein visage !</p>

<p>La limite que je pensais bien ne jamais rencontrer était bien
celle-ci : <strong>la taille maximale d&rsquo;une String</strong></p>

<h2 id="reproduire-le-problème">Reproduire le problème</h2>

<p>Comment on fait pour l&rsquo;atteindre ? Dans mon cas, on met dans une String
l&rsquo;intégralité des informations de chaque artefact d&rsquo;un repository Maven.
Plus simple, on agit de la sorte :</p>

<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="lnt"> 1</span><span class="lnt"> 2</span><span class="lnt"> 3</span><span class="lnt"> 4</span><span class="lnt"> 5</span><span class="lnt"> 6</span><span class="lnt"> 7</span><span class="lnt"> 8</span><span class="lnt"> 9</span><span class="lnt">10</span><span class="lnt">11</span><span class="lnt">12</span><span class="lnt">13</span><span class="lnt">14</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;a&#34;</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">OutOfMemoryError</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></td></tr></table>
</div>
</div>

<p>Je m&rsquo;explique : dans la classe String, ce qui contient la chaîne de
caractères c&rsquo;est en fait un tableau de <strong>char</strong>. L&rsquo;index du tableau, sous-
entendu la taille de la String, est un <strong>int</strong>. Un int est stocké sous
32 bits, donc la valeur maximale que peut prendre un int est 2^31 -1
(cf la documentation en ligne : <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Integer.html#MAX_VALUE">javadoc oracle</a>)</p>

<p>Et donc si on arrive à mettre 2^31 caractères dans une String (via
StringBuilder dans mon cas) on se retrouve avec une belle
<code>OutOfMemoryError</code>.</p>

<p>Là, on fait :</p>

<p><img src="http://i3.kym-cdn.com/entries/icons/original/000/000/554/facepalm.jpg" class="img-polaroid"/></p>

<h2 id="moralité-de-l-histoire">Moralité de l&rsquo;histoire</h2>

<p>Ne jamais se croire à l&rsquo;abris d&rsquo;une OutOfMemoryError car, même avec du
TDD, DDD ou autre, je ne pense qu&rsquo;il existe (sinon il doit se sentir
bien seul..) de développeur qui aurait fait un test unitaire à base de
plusieurs millions de caratères..</p>

<p>Je dois avouer que je ne suis trouvé un peu <em>con</em> sur ce coup-là.</p>

<h2 id="nota-bene">Nota bene</h2>

<p>Un collègue (<a href="http://thecodersbreakfast.net/">Olivier Croisier</a>) m&rsquo;a
donné la bonne idée de passer par un <code>Writer</code> ainsi, je ne stocke
pas de String et donc pas de OutOfMemoryError.</p>

<p>Autre fait important : l&rsquo;output se fait en retour de HTTP GET. Avec un
traitement potentiellement long (celui qui me met +2^31 caractères dans
un String), on peut avoir des Timeout car la réponse n&rsquo;est faite qu&rsquo;en
un coup. Avec le <code>Writer</code>, la réponse est donnée au fur et à mesure. En
combinant ça et HTTP 1.1 (mode connecté), plus de Timeout. La vie est
belle.</p>

  </section>
</article>


</main>

  <footer>
    &copy; Adrien Lecharpentier 2012 - 2017
  </footer>

</body>
</html>

